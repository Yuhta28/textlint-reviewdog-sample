# ref: https://github.com/azu/textlint-reviewdog-example
version: 2.1

jobs:
  proofreading_job:
    docker:
      - image: cimg/node:lts
    steps:
      - checkout
      - run:
          name: "Install textlint"
          command: npm install --save-dev textlint textlint-rule-common-misspellings
      - run:    
          name: "Install dependent module"
          command: npm install
      - run:
          name: "Install reviewdog"
          command: |
            curl -sfL https://raw.githubusercontent.com/reviewdog/reviewdog/master/install.sh| sh -s
      - run: # (d1)
          name: "Execute textlint for README.md"
          command: npx textlint --rule common-misspellings README.md >> .textlint.log
      - run:
          name: Define CIRCLE_PR_NUMBER Environment Variable at Runtime
          when: on_fail
          command: |
            echo "export CI_REPO_OWNER=Yuhta28" >> $BASH_ENV
            echo "export CI_REPO_NAME=textlint-reviewdog-sample" >> $BASH_ENV
            echo "export CIRCLE_PULL_REQUEST=1" >> $BASH_ENV
            echo "export CI_COMMIT=$(git rev-parse HEAD)" >> $BASH_ENV
            source $BASH_ENV
            echo $CIRCLE_PULL_REQUEST
            echo $CI_COMMIT
      - run: # (d2)
          name: "Execute reviewdog"
          when: on_fail
          command: |
            echo $CIRCLE_PULL_REQUEST
            cat .textlint.log | ./bin/reviewdog -f=checkstyle -name="textlint" -reporter="github-pr-review"
workflows:
  version: 2
  proofreading:
    jobs:
      - proofreading_job

